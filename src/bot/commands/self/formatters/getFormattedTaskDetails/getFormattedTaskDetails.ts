import type { TaskFieldsForSummary } from '@types'

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–∞–¥–∞—á–∏
 */
function getNoTestsBlock(): string[] {
  return ['üö´ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è']
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ–∂–∏–¥–∞–µ—Ç –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
 */
function getPendingTestsBlock(): string[] {
  return ['üß™ –û–∂–∏–¥–∞–µ–º –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è']
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –∏ –±–∞–≥–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ
 */
function getPassedWithoutBugsBlock(): string[] {
  return ['–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ –±–µ–∑ –±–∞–≥–æ–≤']
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–æ—Å—å, –Ω–æ –±—ã–ª–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
 */
function getNotConductedBlock(): string[] {
  return ['–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–æ—Å—å']
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –±–∞–≥–∏ –±—ã–ª–∏, –Ω–æ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á—ë—Ç
 */
function getPassedWithBugsBlock(
  taskUrl: string,
  fixed: number,
  total: number
): string[] {
  const summary = `üß™ –í—Å–µ –±–∞–≥–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã | [${fixed}/${total}](${taskUrl})`
  return [summary]
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ—Ä–µ—à—ë–Ω–Ω—ã–µ –±–∞–≥–∏, –≤–∫–ª—é—á–∞—è —Å—á—ë—Ç—á–∏–∫–∏ –∏ —Å—Å—ã–ª–∫—É
 */
function getUnresolvedBugsBlock(
  unresolved: number,
  fixed: number,
  total: number,
  taskUrl?: string
): string[] {
  const block = [
    'üß™ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–∞–≥–∏',
    `–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: ${fixed}/${total}`,
    `–û—Ç–∫—Ä—ã—Ç–æ: ${unresolved}`
  ]

  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  if (taskUrl) {
    block.push(`üîó [–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏](${taskUrl})`)
  }

  return block
}

/**
 * –§–æ—Ä–º–∏—Ä—É–µ—Ç –±–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏
 * –í–∫–ª—é—á–∞–µ—Ç —É—á—ë—Ç —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –Ω–∞–ª–∏—á–∏—è –±–∞–≥–æ–≤ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ç—á—ë—Ç
 */
function getTestsBlock(task: TaskFieldsForSummary): string[] {
  if (!task.tests.isNeeded) {
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
    return getNoTestsBlock()
  }

  const tests = task.tests

  if (!tests.taskUrl) {
    // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –Ω–æ –æ—Ç—á—ë—Ç–∞ –Ω–µ—Ç ‚Üí –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–æ—Å—å
    return getNotConductedBlock()
  }

  const total = tests.all?.length ?? 0
  const unresolved = tests.unresolved?.length ?? 0
  const fixed = total - unresolved

  if (total === 0) {
    // –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –≤–æ–æ–±—â–µ
    if (task.isCompleted) {
      return tests.isCompleted
        ? getPassedWithoutBugsBlock()
        : getNotConductedBlock()
    }

    // –ó–∞–¥–∞—á–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî —Ç–µ—Å—Ç—ã –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∏—Å—å
    return getPendingTestsBlock()
  }

  if (unresolved === 0) {
    // –í—Å–µ –±–∞–≥–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
    return getPassedWithBugsBlock(tests.taskUrl, fixed, total)
  }

  // –ï—Å—Ç—å –Ω–µ—Ä–µ—à—ë–Ω–Ω—ã–µ –±–∞–≥–∏
  return getUnresolvedBugsBlock(unresolved, fixed, total, tests.taskUrl)
}

/**
 * –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ –∑–∞–¥–∞—á–µ
 * –í–∫–ª—é—á–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫, —Å—Ç–∞—Ç—É—Å, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
 */
export function getFormattedTaskDetails(
  task: TaskFieldsForSummary,
  index: number
): string {
  const status = task.isCompleted ? '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞' : '‚è≥ –í —Ä–∞–±–æ—Ç–µ'

  const lines = [
    // –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏
    ...(index === 1 ? ['üåü‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅüåü \n'] : []),

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏ —Å–æ —Å—Å—ã–ª–∫–æ–π
    `**#${index} üìù [${task.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}](${task.taskUrl})** `,

    // –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
    `${status}`,

    // –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    ...getTestsBlock(task)
  ]

  return lines.join('\n')
}
